<script>
  function fetchIco(ico, returnData) {
    let req = new XMLHttpRequest();
    req.open("GET", `https://logo.clearbit.com/${ico}`, true);
    req.responseType = "arraybuffer";
    req.onreadystatechange = () => {
      if (req.readyState === 4) {
        //if complete
        if (req.status === 200) {
          //check if "OK" (200)
          let arrayBuffer = req.response;
          if (arrayBuffer) {
            let imageArray = new Uint8Array(arrayBuffer);
            returnData.icoImg = imageArray;
          }
        } else {
          parent.postMessage({ pluginMessage: { type: "error" } }, "*");
        }
      }
    };
    req.send(null);
  }

  function fetchData(data) {
    let returnData = data;
    fetchIco(data.link, returnData);
    let req = new XMLHttpRequest();
    req.open(
      "GET",
      `https://iframe.ly/api/iframely?url=${data.characters}&api_key=5cc4e3759ecc9a2f152ed9`,
      true
    );
    req.responseType = "json";
    req.onreadystatechange = () => {
      if (req.readyState === 4) {
        //if complete
        if (req.status === 200) {
          console.log(req.response);
          //check if "OK" (200)
          let arrayBuffer = req.response;
          if (arrayBuffer) {
            returnData.iframe = arrayBuffer;
            parent.postMessage(
              { pluginMessage: { type: "returnData", returnData } },
              "*"
            );
          }
        } else {
          parent.postMessage({ pluginMessage: { type: "error" } }, "*");
        }
      }
    };
    req.send(null);
  }

  window.onmessage = async (event) => {
    pmsg = event.data.pluginMessage;

    fetchData(pmsg.selection[0]);
    // });
  };
</script>
